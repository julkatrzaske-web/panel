#!/bin/bash

# Rhost Panel - installer i launcher
# GitHub: https://github.com/julkatrzaske-web/panel

set -e

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Ścieżki
RHOST_DIR="$HOME/.rhost"
PANEL_FILE="$RHOST_DIR/panel.sh"
INSTALL_URL="https://raw.githubusercontent.com/julkatrzaske-web/panel/main/panel.sh"

# Funkcje pomocnicze
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

info() {
    echo -e "${BLUE}Info: $1${NC}"
}

success() {
    echo -e "${GREEN}Success: $1${NC}"
}

warning() {
    echo -e "${YELLOW}Warning: $1${NC}"
}

# Nagłówek
header() {
    clear
    echo -e "${CYAN}"
    cat << "EOF"
  ____  _   _ ____  _   _ _______ 
 |  _ \| | | / ___|| | | |_   _\ \ / /
 | |_) | |_| \___ \| |_| | | |  \ V / 
 |  _ <|  _  |___) |  _  | | |   | |  
 |_| \_\_| |_|____/|_| |_| |_|   |_|  
EOF
    echo -e "${NC}"
    echo "======================================"
    echo
}

# Sprawdź zależności
check_dependencies() {
    local deps=("curl" "wget")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            error "$dep is required but not installed. Please install it first."
        fi
    done
}

# Pobierz najnowszą wersję panelu
update_panel() {
    info "Checking for updates..."
    
    if [[ ! -f "$PANEL_FILE" ]]; then
        info "Downloading Rhost Panel..."
        mkdir -p "$RHOST_DIR"
        curl -sSL "$INSTALL_URL" -o "$PANEL_FILE"
        chmod +x "$PANEL_FILE"
        success "Rhost Panel downloaded successfully!"
    else
        # Sprawdź czy jest nowsza wersja
        local temp_file=$(mktemp)
        curl -sSL "$INSTALL_URL" -o "$temp_file"
        
        if ! cmp -s "$PANEL_FILE" "$temp_file"; then
            info "Updating Rhost Panel..."
            mv "$temp_file" "$PANEL_FILE"
            chmod +x "$PANEL_FILE"
            success "Rhost Panel updated to latest version!"
        else
            rm -f "$temp_file"
            info "Rhost Panel is up to date."
        fi
    fi
}

# Główna funkcja panelu
main_panel() {
    header
    echo -e "${YELLOW}Rhost Panel v1.0${NC}"
    echo
    echo "1. Start Server Management"
    echo "2. Install Dependencies"
    echo "3. Update Panel"
    echo "4. Uninstall Panel"
    echo "5. Exit"
    echo
    
    read -p "Select option: " choice
    
    case $choice in
        1)
            start_server_management
            ;;
        2)
            install_dependencies
            ;;
        3)
            update_panel
            ;;
        4)
            uninstall_panel
            ;;
        5)
            success "Goodbye!"
            exit 0
            ;;
        *)
            error "Invalid choice!"
            ;;
    esac
}

# Zarządzanie serwerami
start_server_management() {
    header
    echo -e "${YELLOW}Server Management${NC}"
    echo
    
    # Sprawdź czy screen jest zainstalowany
    if ! command -v screen &> /dev/null; then
        warning "Screen is not installed. Some features may not work."
        read -p "Do you want to install screen now? (y/n): " install_screen
        if [[ $install_screen == "y" ]]; then
            install_dependencies
        fi
    fi
    
    # Tutaj dodaj pełną funkcjonalność panelu z poprzedniego kodu
    echo "Server management features coming soon..."
    echo
    read -p "Press Enter to continue..."
    main_panel
}

# Instalacja zależności
install_dependencies() {
    header
    echo -e "${YELLOW}Installing Dependencies${NC}"
    echo
    
    if command -v apt-get &> /dev/null; then
        # Debian/Ubuntu
        info "Installing dependencies using apt..."
        sudo apt-get update
        sudo apt-get install -y screen curl wget openjdk-17-jdk
        success "Dependencies installed successfully!"
        
    elif command -v yum &> /dev/null; then
        # CentOS/RHEL
        info "Installing dependencies using yum..."
        sudo yum update -y
        sudo yum install -y screen curl wget java-17-openjdk
        success "Dependencies installed successfully!"
        
    elif command -v dnf &> /dev/null; then
        # Fedora
        info "Installing dependencies using dnf..."
        sudo dnf update -y
        sudo dnf install -y screen curl wget java-17-openjdk
        success "Dependencies installed successfully!"
        
    else
        warning "Cannot detect package manager. Please install manually:"
        echo " - screen"
        echo " - curl"
        echo " - wget"
        echo " - openjdk-17-jdk"
    fi
    
    read -p "Press Enter to continue..."
    main_panel
}

# Odinstaluj panel
uninstall_panel() {
    header
    echo -e "${RED}Uninstall Rhost Panel${NC}"
    echo
    warning "This will remove all Rhost Panel files and configurations!"
    read -p "Are you sure you want to continue? (y/n): " confirm
    
    if [[ $confirm == "y" ]]; then
        if [[ -d "$RHOST_DIR" ]]; then
            rm -rf "$RHOST_DIR"
            success "Rhost Panel has been completely uninstalled!"
        else
            info "Rhost Panel is not installed."
        fi
    else
        info "Uninstall cancelled."
    fi
    
    read -p "Press Enter to continue..."
    main_panel
}

# Funkcja inicjalizująca
init() {
    check_dependencies
    update_panel
    
    # Uruchom główny panel
    main_panel
}

# Uruchom inicjalizację
init "$@"
